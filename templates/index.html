<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>Моніторинг світла</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-dark text-light">
<div class="container py-4 min-vh-100 d-flex flex-column">

  <!-- HEADER -->
  <h1 class="mb-4">Моніторинг світла</h1>

  <!-- STATUS CARD -->
  <div class="card   mb-4">
    <div class="card-body">
      <h5 class="card-title">Статус на {{ now_str }}</h5>
      <p class="card-text">
        {% if current_status is true %}
          <span class="badge bg-success">Онлайн</span>
        {% elif current_status is false %}
          <span class="badge bg-danger">Офлайн</span>
        {% else %}
          <span class="badge bg-secondary">Невідомо</span>
        {% endif %}
      </p>

      {% if stats %}
        <p class="mb-1">
          За сьогодні зі світлом:
          <strong>{{ on_str }}</strong>
        </p>
        <p class="mb-1">
          Без світла:
          <strong>{{ off_str }}</strong>
        </p>

        {% if avail_pct is not none %}
          <p class="mb-0">
            Доступність за день:
            <strong>{{ avail_pct }}%</strong>
          </p>
        {% endif %}
      {% else %}
        <p class="mb-0">Даних за сьогодні поки немає.</p>
      {% endif %}
    </div>
  </div>

  <!-- HOURLY CHART CARD -->
  <div class="card   mb-4">
    <div class="card-body d-flex flex-column">
      <h5 class="card-title">Погодинна доступність за сьогодні</h5>
      <p class="text-muted small">
        Кожен стовпчик показує, який відсоток часу у відповідній годині
        (00–23) дім був з інтернетом / світлом.
      </p>
      <div class="flex-grow-1">
        <canvas id="hourlyChart" height="120"></canvas>
      </div>
    </div>
  </div>

  <!-- HISTORY CARD -->
  <div class="card   flex-grow-1">
    <div class="card-body d-flex flex-column">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="card-title mb-0">Історія відключень</h5>
        <form class="d-flex align-items-center gap-2" onsubmit="return false;">
          <label class="form-label form-label-sm mb-0 text-muted">Період:</label>
          <select name="days" class="form-select form-select-sm">
            {% for opt in [1, 3, 7, 14, 30] %}
              <option value="{{ opt }}" {% if opt == days_window %}selected{% endif %}>
                {{ opt }} дн.
              </option>
            {% endfor %}
          </select>
        </form>
      </div>
      <p class="text-muted small">
        Нижче — підсумки по днях за обраний період та детальний список інтервалів,
        коли світла не було.
      </p>

      <!-- ВОТ ТУТ ДЕЛАЕМ КОНТЕЙНЕР ДЛЯ AJAX -->
      <div class="mt-2" id="history-container">
        {% for day in history_days %}
          <div class="mb-3">
            <div class="fw-semibold">
              {{ day.weekday }} ({{ day.date_str }})
            </div>

            {% if not day.has_data %}
              <div class="text-muted small">Даних немає.</div>
            {% else %}
              <div class="small">
                Відключень: {{ day.outages|length }} ·
                Зі світлом: {{ day.on_str }} ·
                Без світла: {{ day.off_str }}
              </div>

              {% if day.outages %}
                <ul class="small mb-0 mt-1">
                  {% for o in day.outages %}
                    <li>
                      {{ o.start_str }} → {{ o.end_str }}
                      <span class="text-muted">({{ o.duration_str }})</span>
                    </li>
                  {% endfor %}
                </ul>
              {% endif %}
            {% endif %}
          </div>
          {% if not loop.last %}
            <hr class="border-secondary">
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="mt-4 py-3 border-top border-secondary text-center text-light small">
    
    <span class="d-inline-block">
     · час відображається за часом сервера
    </span>
  </footer>

</div>

<script>
  const labels = {{ labels | tojson }};
  const data = {{ hourly_pct | tojson }};

  const ctx = document.getElementById('hourlyChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Онлайн, % часу в годині',
        data: data,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          min: 0,
          max: 100,
          ticks: { stepSize: 25 }
        }
      }
    }
  });

  function renderHistory(historyDays) {
    const container = document.getElementById('history-container');
    if (!container) return;

    let html = '';

    historyDays.forEach((day, index) => {
      html += '<div class="mb-3">';
      html += `<div class="fw-semibold">${day.weekday} (${day.date_str})</div>`;

      if (!day.has_data) {
        html += '<div class="text-muted small">Даних немає.</div>';
      } else {
        html += `<div class="small">
          Відключень: ${day.outages.length} ·
          Зі світлом: ${day.on_str} ·
          Без світла: ${day.off_str}
        </div>`;

        if (day.outages.length > 0) {
          html += '<ul class="small mb-0 mt-1">';
          day.outages.forEach(o => {
            html += `<li>${o.start_str} → ${o.end_str} <span class="text-muted">(${o.duration_str})</span></li>`;
          });
          html += '</ul>';
        }
      }

      html += '</div>';

      if (index < historyDays.length - 1) {
        html += '<hr class="border-secondary">';
      }
    });

    container.innerHTML = html;
  }

  document.addEventListener('DOMContentLoaded', () => {
    const select = document.querySelector('select[name="days"]');
    if (!select) return;

    select.addEventListener('change', () => {
      const days = select.value;

      fetch(`/history-data?days=${encodeURIComponent(days)}`)
        .then(resp => {
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          return resp.json();
        })
        .then(data => {
          if (data && Array.isArray(data.history_days)) {
            renderHistory(data.history_days);
          }
        })
        .catch(err => {
          console.error('Помилка завантаження історії:', err);
        });
    });
  });
</script>
</body>
</html>
